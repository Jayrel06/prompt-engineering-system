#!/bin/bash

# Prompt Engineering System CLI
# Usage: prompt <command> [options]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
Prompt Engineering System CLI

Usage: prompt <command> [options]

Commands:
    plan <description>      Start planning session with full context
    quick <question>        Quick question with minimal context
    project <name> <task>   Load specific project context
    framework <name>        Use specific thinking framework
    handoff <description>   Generate Claude Code handoff prompt
    search <query>          Search knowledge base
    capture <file>          Capture output to knowledge base
    reflect                 Trigger reflection/learning prompt
    list-frameworks         List available thinking frameworks
    list-templates          List available templates
    status                  Check system status

Options:
    -m, --model <model>     Override model selection (opus/sonnet/haiku)
    -v, --verbose           Show context assembly details
    -o, --output <file>     Write assembled prompt to file
    -h, --help              Show this help

Examples:
    prompt plan "Q1 strategy for CoreReceptionAI"
    prompt quick "Best way to structure Docker networks"
    prompt framework first-principles "Should I add Langfuse?"
    prompt handoff "Build lead scoring system in n8n"
    prompt list-frameworks

EOF
}

list_frameworks() {
    echo -e "${GREEN}Available Thinking Frameworks:${NC}"
    echo ""
    echo "Planning:"
    ls -1 "$PROJECT_ROOT/frameworks/planning/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Analysis:"
    ls -1 "$PROJECT_ROOT/frameworks/analysis/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Decision:"
    ls -1 "$PROJECT_ROOT/frameworks/decision/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Technical:"
    ls -1 "$PROJECT_ROOT/frameworks/technical/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Communication:"
    ls -1 "$PROJECT_ROOT/frameworks/communication/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
}

list_templates() {
    echo -e "${GREEN}Available Templates:${NC}"
    echo ""
    echo "Voice AI:"
    ls -1 "$PROJECT_ROOT/templates/voice-ai/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Development:"
    ls -1 "$PROJECT_ROOT/templates/development/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Outreach:"
    ls -1 "$PROJECT_ROOT/templates/outreach/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
    echo ""
    echo "Client:"
    ls -1 "$PROJECT_ROOT/templates/client/" 2>/dev/null | sed 's/.md$//' | sed 's/^/  - /'
}

check_status() {
    echo -e "${GREEN}System Status:${NC}"
    echo ""

    # Check if Python is available
    if command -v python3 &> /dev/null; then
        echo -e "  Python3: ${GREEN}Available${NC}"
    else
        echo -e "  Python3: ${RED}Not found${NC}"
    fi

    # Check if LiteLLM is running
    if curl -s http://localhost:4000/health > /dev/null 2>&1; then
        echo -e "  LiteLLM: ${GREEN}Running${NC}"
    else
        echo -e "  LiteLLM: ${YELLOW}Not running${NC}"
    fi

    # Check if Qdrant is running
    if curl -s http://localhost:6333/ > /dev/null 2>&1; then
        echo -e "  Qdrant:  ${GREEN}Running${NC}"
    else
        echo -e "  Qdrant:  ${YELLOW}Not running${NC}"
    fi

    # Count resources
    echo ""
    echo "Resources:"
    echo "  Frameworks: $(find "$PROJECT_ROOT/frameworks" -name "*.md" 2>/dev/null | wc -l)"
    echo "  Templates:  $(find "$PROJECT_ROOT/templates" -name "*.md" 2>/dev/null | wc -l)"
    echo "  Context:    $(find "$PROJECT_ROOT/context" -name "*.md" 2>/dev/null | wc -l)"
}

# Parse command
case "$1" in
    plan)
        shift
        python3 "$SCRIPT_DIR/context-loader.py" --mode full --task "$*"
        ;;
    quick)
        shift
        python3 "$SCRIPT_DIR/context-loader.py" --mode minimal --task "$*"
        ;;
    project)
        project_name="$2"
        shift 2
        python3 "$SCRIPT_DIR/context-loader.py" --mode project --project "$project_name" --task "$*"
        ;;
    framework)
        framework_name="$2"
        shift 2
        python3 "$SCRIPT_DIR/context-loader.py" --mode framework --framework "$framework_name" --task "$*"
        ;;
    handoff)
        shift
        python3 "$SCRIPT_DIR/context-loader.py" --mode handoff --task "$*"
        ;;
    search)
        shift
        echo -e "${YELLOW}Search not yet implemented. Use grep for now:${NC}"
        echo "grep -r '$*' $PROJECT_ROOT/context/"
        ;;
    capture)
        echo -e "${YELLOW}Capture not yet implemented.${NC}"
        ;;
    reflect)
        echo -e "${YELLOW}Reflect not yet implemented.${NC}"
        ;;
    list-frameworks)
        list_frameworks
        ;;
    list-templates)
        list_templates
        ;;
    status)
        check_status
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        if [ -z "$1" ]; then
            show_help
        else
            echo -e "${RED}Unknown command: $1${NC}"
            echo ""
            show_help
            exit 1
        fi
        ;;
esac
